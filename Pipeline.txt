pipeline{
    agent any
    stages{
        stage('checkout source code'){
            steps{
                cleanWs()
                git branch: 'main', credentialsId: 'gitcred', url: ‘https://github.com/srkdevops15/java_demo’
            }
        }
        stage('sonarscan'){
            steps{
                script{
                def mvn = tool 'maven3.9.4';
                withSonarQubeEnv('sonar') {
                  sh "mvn clean verify sonar:sonar -Dsonar.projectKey=test_yewudywd -Dsonar.projectName='test'" 
                }
                }
            }
        }
        stage('create the binaries'){
            steps{
                sh "mvn clean install"
                // sh "mv webapp/target/webapp.war webapp/target/webapp-${BUILD_NUMBER}.war"                 
            }
        }
        stage('create image'){
            steps{
                sh "docker build -t srkdevops15.jfrog.io/docker-test/app-a:${ BUILD_NUMBER } ."
                withCredentials([usernamePassword(credentialsId: 'jfrog_docker', passwordVariable: 'pass', usernameVariable: 'user')]) {
                    sh "docker login -u ${ user } -p ${ pass }srkdevops15.jfrog.io"
                }
                sh "docker pushsrkdevops15.jfrog.io/docker-test/app-a:${ BUILD_NUMBER }"
            }
        }
        stage('deploy on eks'){
            steps{
                withAWS(credentials: 'aws_login', region: 'us-east-1') {
                    sh "aws eks update-kubeconfig --region us-east-1 --name my-eks-cluster"
                    sh "kubectl apply -f test.yaml"
                    sleep 10
                    sh "kubectl get all"
                }
            }
        }
    }
}
